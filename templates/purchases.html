<!-- templates/purchases.html -->
{% extends 'base.html' %}
{% block title %}Plano de Compras - PCP Game{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="text-center mb-5">Plano de Compras</h2>
    <p class="fs-1 fw-bolder ">Você está atualmente no período {{ current_user.periodo_atual }}.</p>

    <form method="POST">
        {{ form.hidden_tag() }}

        <!-- Card para Fio de Algodão -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Fio de Algodão</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Período</th>
                            {% for period in periods %}
                                <th>{{ period }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Consumo Previsto</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control consumo-previsto" 
                                           id="fio_algodao_consumo_previsto_{{ period }}" 
                                           name="{{ consumo_previsto_por_material['Fio Algodao'][period].name }}"
                                           value="{{ consumo_previsto_por_material['Fio Algodao'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Consumo Real</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control consumo-real" 
                                           id="fio_algodao_consumo_real_{{ period }}" 
                                           name="{{ consumo_real_por_material['Fio Algodao'][period].name }}"
                                           value="{{ consumo_real_por_material['Fio Algodao'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Estoques Iniciais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control estoque-inicial" 
                                           id="fio_algodao_estoque_inicial_{{ period }}" 
                                           name="{{ estoques_iniciais_por_material['Fio Algodao'][period].name }}"
                                           value="{{ estoques_iniciais_por_material['Fio Algodao'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Planejadas</th>
                            {% for period in periods %}
                                <td>
                                    {% if period <= periodo_atual %}
                                        <input type="number" class="form-control compra-planejada"
                                               id="fio_algodao_compra_planejada_{{ period }}"
                                               name="{{ compras_por_material['Fio Algodao'][period].name }}"
                                               data-material="Fio Algodao" data-period="{{ period }}"
                                               value="{{ compras_por_material['Fio Algodao'][period].data }}" readonly>
                                    {% else %}
                                        {{ compras_por_material['Fio Algodao'][period](class="form-control compra-planejada", id="fio_algodao_compra_planejada_" ~ period, data_material="Fio Algodão", data_period=period) }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Reais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control compra-real" 
                                           id="fio_algodao_compra_real_{{ period }}" 
                                           name="{{ compras_real_por_material['Fio Algodao'][period].name }}"
                                           value="{{ compras_real_por_material['Fio Algodao'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Emergênciais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control compra-emergencial" 
                                           id="fio_algodao_compra_emergencial_{{ period }}" 
                                           name="{{ compras_emergencial_por_material['Fio Algodao'][period].name }}"
                                           value="{{ compras_emergencial_por_material['Fio Algodao'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Estoques Finais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control estoque-final" 
                                           id="fio_algodao_estoque_final_{{ period }}" 
                                           name="{{ estoques_finais_por_material['Fio Algodao'][period].name }}"
                                           value="{{ estoques_finais_por_material['Fio Algodao'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Card para Fio Sintético -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h4>Fio Sintético</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Período</th>
                            {% for period in periods %}
                                <th>{{ period }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Consumo Previsto</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control consumo-previsto" 
                                           id="fio_sintetico_consumo_previsto_{{ period }}" 
                                           name="{{ consumo_previsto_por_material['Fio Sintetico'][period].name }}"
                                           value="{{ consumo_previsto_por_material['Fio Sintetico'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Consumo Real</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control consumo-real" 
                                           id="fio_sintetico_consumo_real_{{ period }}" 
                                           name="{{ consumo_real_por_material['Fio Sintetico'][period].name }}"
                                           value="{{ consumo_real_por_material['Fio Sintetico'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Estoques Iniciais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control estoque-inicial" 
                                           id="fio_sintetico_estoque_inicial_{{ period }}" 
                                           name="{{ estoques_iniciais_por_material['Fio Sintetico'][period].name }}"
                                           value="{{ estoques_iniciais_por_material['Fio Sintetico'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Planejadas</th>
                            {% for period in periods %}
                                <td>
                                    {% if period <= periodo_atual %}
                                        <input type="number" class="form-control compra-planejada"
                                               id="fio_sintetico_compra_planejada_{{ period }}"
                                               name="{{ compras_por_material['Fio Sintetico'][period].name }}"
                                               value="{{ compras_por_material['Fio Sintetico'][period].data }}" readonly>
                                    {% else %}
                                        {{ compras_por_material['Fio Sintetico'][period](class="form-control compra-planejada", id="fio_sintetico_compra_planejada_" ~ period) }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Reais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control compra-real" 
                                           id="fio_sintetico_compra_real_{{ period }}" 
                                           name="{{ compras_real_por_material['Fio Sintetico'][period].name }}"
                                           value="{{ compras_real_por_material['Fio Sintetico'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Emergênciais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control compra-emergencial" 
                                           id="fio_sintetico_compra_emergencial_{{ period }}" 
                                           name="{{ compras_emergencial_por_material['Fio Sintetico'][period].name }}"
                                           value="{{ compras_emergencial_por_material['Fio Sintetico'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Estoques Finais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control estoque-final" 
                                           id="fio_sintetico_estoque_final_{{ period }}" 
                                           name="{{ estoques_finais_por_material['Fio Sintetico'][period].name }}"
                                           value="{{ estoques_finais_por_material['Fio Sintetico'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Card para Corantes -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4>Corantes</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Período</th>
                            {% for period in periods %}
                                <th>{{ period }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Consumo Previsto</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control consumo-previsto" 
                                           id="corantes_consumo_previsto_{{ period }}" 
                                           name="{{ consumo_previsto_por_material['Corantes'][period].name }}"
                                           value="{{ consumo_previsto_por_material['Corantes'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Consumo Real</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control consumo-real" 
                                           id="corantes_consumo_real_{{ period }}" 
                                           name="{{ consumo_real_por_material['Corantes'][period].name }}"
                                           value="{{ consumo_real_por_material['Corantes'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Estoques Iniciais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control estoque-inicial" 
                                           id="corantes_estoque_inicial_{{ period }}" 
                                           name="{{ estoques_iniciais_por_material['Corantes'][period].name }}"
                                           value="{{ estoques_iniciais_por_material['Corantes'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Planejadas</th>
                            {% for period in periods %}
                                <td>
                                    {% if period <= periodo_atual %}
                                        <input type="number" class="form-control compra-planejada"
                                               id="corantes_compra_planejada_{{ period }}"
                                               name="{{ compras_por_material['Corantes'][period].name }}"
                                               value="{{ compras_por_material['Corantes'][period].data }}" readonly>
                                    {% else %}
                                        {{ compras_por_material['Corantes'][period](class="form-control compra-planejada", id="corantes_compra_planejada_" ~ period) }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Reais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control compra-real" 
                                           id="corantes_compra_real_{{ period }}" 
                                           name="{{ compras_real_por_material['Corantes'][period].name }}"
                                           value="{{ compras_real_por_material['Corantes'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Compras Emergênciais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control compra-emergencial" 
                                           id="corantes_compra_emergencial_{{ period }}" 
                                           name="{{ compras_emergencial_por_material['Corantes'][period].name }}"
                                           value="{{ compras_emergencial_por_material['Corantes'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>Estoques Finais</th>
                            {% for period in periods %}
                                <td>
                                    <input type="number" class="form-control estoque-final" 
                                           id="corantes_estoque_final_{{ period }}" 
                                           name="{{ estoques_finais_por_material['Corantes'][period].name }}"
                                           value="{{ estoques_finais_por_material['Corantes'][period].data }}" readonly>
                                </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botão de ação destacado -->
        <div class="text-center mb-4">
            <button type="submit" class="btn btn-lg btn-success">Salvar Plano de Compras</button>
        </div>
    </form>
</div>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Declarar periods como uma variável global para evitar conflito
        const periods = JSON.parse('{{ periods|tojson }}');
        let periodo_atual = '{{ periodo_atual }}';
        console.log(periodo_atual);

        function recalcularEstoques(material) {
            for (let i = 0; i <= periods.length; i++) {
                let period = periods[i];
                let nextPeriod = periods[i + 1];

                if (period > periodo_atual){
                    // Obter os valores
                    let estoqueInicialElem = document.getElementById(`${material}_estoque_inicial_${period}`);
                    let compraPlanejadaElem = document.getElementById(`${material}_compra_planejada_${period}`);
                    let compraEmergencialElem = document.getElementById(`${material}_compra_emergencial_${period}`);
                    let consumoPrevistoElem = document.getElementById(`${material}_consumo_previsto_${period}`);
                    let estoquesFinaisElem = document.getElementById(`${material}_estoque_final_${period}`);
    
                    // Verificar se os elementos existem antes de acessar seus valores
                    if (estoqueInicialElem && compraPlanejadaElem && consumoPrevistoElem) {
                        let estoqueInicial = parseFloat(estoqueInicialElem.value) || 0;
                        let estoqueFinal = parseFloat(estoquesFinaisElem.value) || 0;
                        let compraPlanejada = parseFloat(compraPlanejadaElem.value) || 0;
                        let compraEmergencial = parseFloat(compraEmergencialElem.value) || 0;
                        let consumoPrevisto = parseFloat(consumoPrevistoElem.value) || 0;

                        // Compras emergenciais checar Primeiro
                        if (compraPlanejada + estoqueInicial <= consumoPrevisto){
                            compraEmergencialElem.value = (consumoPrevisto - compraPlanejada - estoqueInicial).toFixed(0)
                        }
                        else {
                            compraEmergencialElem.value = 0
                        }

                        // Calcular o estoque final e atualizar o estoque inicial do próximo período
                        let estoqueInicialFinal = estoqueInicial + compraPlanejada - consumoPrevisto;
                        let estoqueFinalFinal = compraPlanejada - consumoPrevisto + estoqueInicial;

                        let nextEstoqueInicialElem = document.getElementById(`${material}_estoque_inicial_${nextPeriod}`);
                        if (nextEstoqueInicialElem) {
                            if (estoqueFinalFinal < 0) {
                                nextEstoqueInicialElem.value = 0
                            }
                            else {
                                nextEstoqueInicialElem.value = estoqueInicialFinal.toFixed(0);
                            }
                        }

                        if (estoquesFinaisElem) {
                            if (estoqueFinalFinal < 0) {
                                estoquesFinaisElem.value = 0
                            }
                            else {
                                estoquesFinaisElem.value = estoqueFinalFinal.toFixed(0);
                            }
                        }
                    }
                }
            }
        }

        // Função para adicionar event listeners
        function adicionarListenersParamaterial(material) {
            // Adicionar event listeners para todos os inputs de compras planejadas
            periods.forEach(function(period) {
                const compraPlanejadaInput = document.getElementById(`${material}_compra_planejada_${period}`);

                if (compraPlanejadaInput) {
                    compraPlanejadaInput.addEventListener('input', function() {
                        recalcularEstoques(material);  // Recalcular estoques quando o valor mudar
                    });
                }
            });
        }

        // Adicionar event listeners para cada material (Fio Algodao, Piquet, Maxim)
        adicionarListenersParamaterial('fio_algodao');
        adicionarListenersParamaterial('fio_sintetico');
        adicionarListenersParamaterial('corantes');

        // Inicialmente calcular os estoques quando a página for carregada
        recalcularEstoques('fio_algodao');
        recalcularEstoques('fio_sintetico');
        recalcularEstoques('corantes');

    });

</script>
{% endblock %}
