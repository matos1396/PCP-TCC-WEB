<!-- templates/tecelagem.html -->
{% extends 'base.html' %}
{% block title %}Plano de Tecelagem - PCP Game{% endblock %}
{% block content %}
<h2 class="mb-4">Plano de Tecelagem</h2>
<p>Você está atualmente no período {{ periodo_atual }}.</p>
<form method="POST">
    {{ form.hidden_tag() }}

    <!-- Tabela Capacidade Necessária -->
    <h4>Capacidade Necessária</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Período</th>
                {% for period in periods %}
                    <th>{{ period }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Capacidade Disponível</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_disponivel_1_{{ period }}" 
                           value="{{ capacidade_disponivel['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Necessária</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_necessaria_{{ period }}" 
                           value="{{ capacidade_necessaria['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Colméia</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="colmeia_horas_{{ period }}" 
                           value="{{ colmeia_horas['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Piquet</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="piquet_horas_{{ period }}" 
                           value="{{ piquet_horas['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Maxim</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="maxim_horas_{{ period }}" 
                           value="{{ maxim_horas['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Setup</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="setup_{{ period }}" 
                           value="{{ setup['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Produtividade</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="produtividade_{{ period }}" 
                           value="{{ produtividade['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <!-- Tabela Capacidade Disponível -->
    <h4>Capacidade Disponível</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Período</th>
                {% for period in periods %}
                    <th>{{ period }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Capacidade Disponível</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_disponivel_2_{{ period }}" 
                           value="{{ capacidade_disponivel['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Instalada</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_instalada_{{ period }}" 
                           value="{{ capacidade_instalada['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Número de Turnos</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <!-- Campo somente leitura para períodos passados -->
                    <input type="number" class="form-control numero-turnos" 
                           id="numero_turnos_{{ period }}"
                           name="{{ numero_turnos['Teares'][period].name }}"
                           value="{{ numero_turnos['Teares'][period].data }}" readonly>
                    {% else %}
                        {{ numero_turnos['Teares'][period](class="form-control numero-turnos", id="numero_turnos_" ~ period) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Terceirizada</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="capacidade_terceirizada_{{ period }}"
                           name="{{ capacidade_teceirizada['Teares'][period].name }}"
                           value="{{ capacidade_teceirizada['Teares'][period].data|int }}" readonly>
                    {% else %}
                        {{ capacidade_teceirizada['Teares'][period](class="form-control capacidade-terceirizada", id="capacidade_terceirizada_" ~ period, step=420) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <!-- Tabela Capacidade Futura -->
    <h4>Ampliações e Reduções</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Período</th>
                {% for period in periods %}
                    <th>{{ period }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Linha para Quantidade -->
            <tr>
                <th>Quantidade</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="quantidade_{{ period }}" 
                           value="{{ quantidade['Teares'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <!-- Linha para Ampliações -->
            <tr>
                <th>Ampliações</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <!-- Campo somente leitura para períodos passados -->
                    <input type="number" class="form-control" 
                           id="ampliacoes_{{ period }}"
                           name="{{ ampliacoes['Teares'][period].name }}"
                           value="{{ ampliacoes['Teares'][period].data|int }}" readonly>
                    {% else %}
                        {{ ampliacoes['Teares'][period](class="form-control", id="ampliacoes_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <!-- Linha para Reduções -->
            <tr>
                <th>Reduções</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <!-- Campo somente leitura para períodos passados -->
                    <input type="number" class="form-control" 
                           id="reducoes_{{ period }}"
                           name="{{ reducoes['Teares'][period].name }}"
                           value="{{ reducoes['Teares'][period].data|int }}" readonly>
                    {% else %}
                        {{ reducoes['Teares'][period](class="form-control", id="reducoes_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>


    <!-- Botão para submeter o formulário -->
    <button type="submit" class="btn btn-primary">Salvar Plano de Teares</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const periods = JSON.parse('{{ periods|tojson }}');
        let periodo_atual = parseInt('{{ periodo_atual }}');
        const capacidadeTerceirizadaInicial = {};
        const quantidadeInicial = {};

        // Salvar o valor inicial de capacidade terceirizada e quantidade para cada período
        periods.forEach(function(period) {
            const capacidadeTerceirizadaInput = document.getElementById(`capacidade_terceirizada_${period}`);
            const quantidadeInput = document.getElementById(`quantidade_${period}`);

            if (capacidadeTerceirizadaInput && quantidadeInput) {
                capacidadeTerceirizadaInicial[period] = parseInt(capacidadeTerceirizadaInput.value) || 0;
                quantidadeInicial[period] = parseInt(quantidadeInput.value) || 0;
            }
        });

        // Função para recalcular quantidades considerando ampliações e reduções
        function recalcularQuantidades() {
            // Primeiro, recalcular quantidades para todos os períodos futuros
            periods.forEach(function(p) {
                if (p >= periodo_atual) {
                    let quantidadeBase = parseInt(quantidadeInicial[p]) || 0;

                    // Acumular ampliações que afetam o período atual (lead time de 2 períodos)
                    let totalAmpliacoes = 0;
                    periods.forEach(function(prevPeriod) {
                        if (prevPeriod < p && (parseInt(prevPeriod) + 2) <= p) {
                            const prevAmpliacoesInput = document.getElementById(`ampliacoes_${prevPeriod}`);
                            if (prevAmpliacoesInput) {
                                totalAmpliacoes += parseInt(prevAmpliacoesInput.value) || 0;
                            }
                        }
                    });

                    // Acumular reduções que afetam o período atual (lead time de 2 períodos)
                    let totalReducoes = 0;
                    periods.forEach(function(prevPeriod) {
                        if (prevPeriod < p && (parseInt(prevPeriod) + 2) <= p) {
                            const prevReducoesInput = document.getElementById(`reducoes_${prevPeriod}`);
                            if (prevReducoesInput) {
                                totalReducoes += parseInt(prevReducoesInput.value) || 0;
                            }
                        }
                    });

                    const quantidadeInput = document.getElementById(`quantidade_${p}`);
                    if (quantidadeInput) {
                        // Calcular a nova quantidade considerando ampliações e reduções
                        let novaQuantidade = quantidadeBase + totalAmpliacoes - totalReducoes;
                        // Evitar que a quantidade fique negativa
                        if (novaQuantidade < 0) {
                            novaQuantidade = 0;
                        }
                        quantidadeInput.value = novaQuantidade;
                    }
                }
            });

            // Depois, recalcular capacidades
            recalcularCapacidadeDisponivel();
        }

        // Função para recalcular a capacidade disponível considerando turnos, quantidade de máquinas e capacidade terceirizada
        function recalcularCapacidadeDisponivel() {
            periods.forEach(function(period) {
                const turnosInput = document.getElementById(`numero_turnos_${period}`);
                const quantidadeInput = document.getElementById(`quantidade_${period}`);
                const capacidadeTerceirizadaInput = document.getElementById(`capacidade_terceirizada_${period}`);
                const capacidadeInstaladaInput = document.getElementById(`capacidade_instalada_${period}`);
                const capacidadeDisponivelInput1 = document.getElementById(`capacidade_disponivel_1_${period}`);
                const capacidadeDisponivelInput2 = document.getElementById(`capacidade_disponivel_2_${period}`);

                if (turnosInput && quantidadeInput && capacidadeTerceirizadaInput && capacidadeDisponivelInput1 && capacidadeDisponivelInput2 && capacidadeInstaladaInput) {
                    let numeroTurnos = parseInt(turnosInput.value) || 0;
                    let quantidade = parseInt(quantidadeInput.value) || 0;
                    let capacidadeTerceirizadaAtual = parseInt(capacidadeTerceirizadaInput.value) || 0;

                    // Calcular capacidade instalada
                    let capacidadeInstalada = quantidade * numeroTurnos * 7 * 20; // Ajuste o fator conforme necessário
                    capacidadeInstaladaInput.value = capacidadeInstalada;

                    // Calcular capacidade disponível
                    let capacidadeDisponivel = capacidadeInstalada + capacidadeTerceirizadaAtual;
                    capacidadeDisponivelInput1.value = capacidadeDisponivel;
                    capacidadeDisponivelInput2.value = capacidadeDisponivel;
                }
            });
        }

        // Adicionar event listeners para os inputs de número de turnos, capacidade terceirizada, quantidade, ampliações e reduções
        periods.forEach(function(period) {
            const turnosInput = document.getElementById(`numero_turnos_${period}`);
            const capacidadeTerceirizadaInput = document.getElementById(`capacidade_terceirizada_${period}`);
            const quantidadeInput = document.getElementById(`quantidade_${period}`);
            const ampliacoesInput = document.getElementById(`ampliacoes_${period}`);
            const reducoesInput = document.getElementById(`reducoes_${period}`);

            if (turnosInput) {
                turnosInput.addEventListener('input', recalcularCapacidadeDisponivel);
            }

            if (capacidadeTerceirizadaInput) {
                capacidadeTerceirizadaInput.addEventListener('input', recalcularCapacidadeDisponivel);
            }

            if (quantidadeInput) {
                quantidadeInput.addEventListener('input', recalcularCapacidadeDisponivel);
            }

            if (ampliacoesInput) {
                ampliacoesInput.addEventListener('input', recalcularQuantidades);
            }

            if (reducoesInput) {
                reducoesInput.addEventListener('input', recalcularQuantidades);
            }
        });

        // Inicialmente calcular a capacidade disponível ao carregar a página
        recalcularQuantidades();
    });
</script>





{% endblock %}
