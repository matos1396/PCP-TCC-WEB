<!-- templates/purga_tinturaria.html -->
{% extends 'base.html' %}
{% block title %}Plano de Purga e Tinturaria - PCP Game{% endblock %}
{% block content %}
<h2 class="mb-4">Plano de Purga e Tinturaria</h2>
<p>Você está atualmente no período {{ periodo_atual }}.</p>
<form method="POST">
    {{ form.hidden_tag() }}

    <!-- Tabela Capacidade Necessária -->
    <h4>Capacidade Necessária</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Período</th>
                {% for period in periods %}
                    <th>{{ period }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Capacidade Disponível</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_disponivel_1_{{ period }}" 
                           value="{{ capacidade_disponivel['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Necessária</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_necessaria_{{ period }}" 
                           value="{{ capacidade_necessaria['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Colméia</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="colmeia_horas_{{ period }}" 
                           value="{{ colmeia_horas['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Piquet</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="piquet_horas_{{ period }}" 
                           value="{{ piquet_horas['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Maxim</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="maxim_horas_{{ period }}" 
                           value="{{ maxim_horas['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Setup</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="setup_{{ period }}" 
                           value="{{ setup['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Produtividade</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="produtividade_{{ period }}" 
                           value="{{ produtividade['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <!-- Tabela Capacidade Disponível -->
    <h4>Capacidade Disponível</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Período</th>
                {% for period in periods %}
                    <th>{{ period }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Capacidade Disponível</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_disponivel_2_{{ period }}" 
                           value="{{ capacidade_disponivel['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Instalada Jet 1</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_instalada_jet1_{{ period }}" 
                           value="{{ capacidade_instalada_jet1['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Instalada Jet 2</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_instalada_jet2_{{ period }}" 
                           value="{{ capacidade_instalada_jet2['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Instalada Jet 3</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="capacidade_instalada_jet3_{{ period }}" 
                           value="{{ capacidade_instalada_jet3['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Número de Turnos</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <!-- Campo somente leitura para períodos passados -->
                    <input type="number" class="form-control numero-turnos" 
                           id="numero_turnos_{{ period }}"
                           name="{{ numero_turnos['Jet'][period].name }}"
                           value="{{ numero_turnos['Jet'][period].data }}" readonly>
                    {% else %}
                        {{ numero_turnos['Jet'][period](class="form-control numero-turnos", id="numero_turnos_" ~ period) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th>Capacidade Terceirizada</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="capacidade_terceirizada_{{ period }}"
                           name="{{ capacidade_teceirizada['Jet'][period].name }}"
                           value="{{ capacidade_teceirizada['Jet'][period].data }}" readonly>
                    {% else %}
                        {{ capacidade_teceirizada['Jet'][period](class="form-control capacidade-terceirizada", id="capacidade_terceirizada_" ~ period, step=11200) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <!-- Tabela Capacidade Futura -->
    <h4>Ampliações e Reduções</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Período</th>
                {% for period in periods %}
                    <th>{{ period }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Linha para Quantidade -->
            <tr>
                <th>Quantidade Jet 1</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="quantidade_jet1_{{ period }}" 
                           value="{{ quantidade_jet1['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <!-- Linha para Ampliações Jet1 -->
            <tr>
                <th>Ampliações Jet 1</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <!-- Campo somente leitura para períodos passados -->
                    <input type="number" class="form-control" 
                           id="ampliacoes_jet1_{{ period }}"
                           name="{{ ampliacoes_jet1['Jet'][period].name }}"
                           value="{{ ampliacoes_jet1['Jet'][period].data|int }}" readonly>
                    {% else %}
                        {{ ampliacoes_jet1['Jet'][period](class="form-control", id="ampliacoes_jet1_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            <!-- Linha para Reduções Jet1 -->
            <tr>
                <th>Reduções Jet 1</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="reducoes_jet1_{{ period }}"
                           name="{{ reducoes_jet1['Jet'][period].name }}"
                           value="{{ reducoes_jet1['Jet'][period].data|int }}" readonly>
                    {% else %}
                        {{ reducoes_jet1['Jet'][period](class="form-control", id="reducoes_jet1_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            
            <!-- Linha para Quantidade -->
            <tr>
                <th>Quantidade Jet 2</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="quantidade_jet2_{{ period }}" 
                           value="{{ quantidade_jet2['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <!-- Linha para Ampliações Jet2 -->
            <tr>
                <th>Ampliações Jet 2</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="ampliacoes_jet2_{{ period }}"
                           name="{{ ampliacoes_jet2['Jet'][period].name }}"
                           value="{{ ampliacoes_jet2['Jet'][period].data|int }}" readonly>
                    {% else %}
                        {{ ampliacoes_jet2['Jet'][period](class="form-control", id="ampliacoes_jet2_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            <!-- Linha para Reduções Jet2 -->
            <tr>
                <th>Reduções Jet 2</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="reducoes_jet2_{{ period }}"
                           name="{{ reducoes_jet2['Jet'][period].name }}"
                           value="{{ reducoes_jet2['Jet'][period].data|int }}" readonly>
                    {% else %}
                        {{ reducoes_jet2['Jet'][period](class="form-control", id="reducoes_jet2_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            <!-- Linha para Quantidade -->
            <tr>
                <th>Quantidade Jet 3</th>
                {% for period in periods %}
                <td>
                    <input type="number" class="form-control" 
                           id="quantidade_jet3_{{ period }}" 
                           value="{{ quantidade_jet3['Jet'][period].data }}" readonly>
                </td>
                {% endfor %}
            </tr>
            <!-- Linha para Ampliações Jet3 -->
            <tr>
                <th>Ampliações Jet 3</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="ampliacoes_jet3_{{ period }}"
                           name="{{ ampliacoes_jet3['Jet'][period].name }}"
                           value="{{ ampliacoes_jet3['Jet'][period].data|int }}" readonly>
                    {% else %}
                        {{ ampliacoes_jet3['Jet'][period](class="form-control", id="ampliacoes_jet3_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>

            <!-- Linha para Reduções Jet3 -->
            <tr>
                <th>Reduções Jet 3</th>
                {% for period in periods %}
                <td>
                    {% if period <= periodo_atual %}
                    <input type="number" class="form-control" 
                           id="reducoes_jet3_{{ period }}"
                           name="{{ reducoes_jet3['Jet'][period].name }}"
                           value="{{ reducoes_jet3['Jet'][period].data|int }}" readonly>
                    {% else %}
                        {{ reducoes_jet3['Jet'][period](class="form-control", id="reducoes_jet3_" ~ period, step=1) }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>

    <!-- Botão para submeter o formulário -->
    <button type="submit" class="btn btn-primary">Salvar Plano de Jet</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const periods = JSON.parse('{{ periods|tojson }}');
    let periodo_atual = '{{ periodo_atual }}';
    const capacidadeInicial = {};
    const capacidadeTerceirizadaInicial = {};

    // Salvar o valor inicial de capacidade disponível e capacidade terceirizada para cada período
    periods.forEach(function(period) {
        const capacidadeInput1 = document.getElementById(`capacidade_disponivel_1_${period}`);
        const capacidadeInput2 = document.getElementById(`capacidade_disponivel_2_${period}`);
        const capacidadeTerceirizadaInput = document.getElementById(`capacidade_terceirizada_${period}`);
        
        if (capacidadeInput1 && capacidadeInput2 && capacidadeTerceirizadaInput) {
            capacidadeInicial[period] = {
                input1: parseInt(capacidadeInput1.value) || 0,
                input2: parseInt(capacidadeInput2.value) || 0
            };
            capacidadeTerceirizadaInicial[period] = parseInt(capacidadeTerceirizadaInput.value) || 0;
        }
    });

    // Função para recalcular a capacidade disponível considerando turnos, quantidade de máquinas e capacidade terceirizada para cada tipo de Jet
    function recalcularCapacidadeDisponivel() {
        periods.forEach(function(period) {
            // Selecionar os campos de número de turnos, quantidade de máquinas e capacidade terceirizada
            const turnosInput = document.getElementById(`numero_turnos_${period}`);
            const quantidadeJet1Input = document.getElementById(`quantidade_jet1_${period}`);
            const quantidadeJet2Input = document.getElementById(`quantidade_jet2_${period}`);
            const quantidadeJet3Input = document.getElementById(`quantidade_jet3_${period}`);
            const capacidadeTerceirizadaInput = document.getElementById(`capacidade_terceirizada_${period}`);
            
            // Selecionar os campos de capacidade disponível
            const capacidadeDisponivelInput1 = document.getElementById(`capacidade_disponivel_1_${period}`);
            const capacidadeDisponivelInput2 = document.getElementById(`capacidade_disponivel_2_${period}`);

            if (turnosInput && quantidadeJet1Input && quantidadeJet2Input && quantidadeJet3Input && capacidadeTerceirizadaInput && capacidadeDisponivelInput1 && capacidadeDisponivelInput2) {
                // Obter o valor inicial de turnos
                let turnosIniciais = parseInt(turnosInput.getAttribute('value')) || 0;
                // Obter o valor atual de turnos
                let numeroTurnos = parseInt(turnosInput.value) || 0;
                // Obter a quantidade de máquinas para cada tipo de Jet
                let quantidadeJet1 = parseInt(quantidadeJet1Input.value) || 0;
                let quantidadeJet2 = parseInt(quantidadeJet2Input.value) || 0;
                let quantidadeJet3 = parseInt(quantidadeJet3Input.value) || 0;

                // Calcular a diferença de turnos
                let diferencaTurnos = numeroTurnos - turnosIniciais;

                // Inicializar variáveis para a nova capacidade
                let novaCapacidade1 = capacidadeInicial[period].input1;
                let novaCapacidade2 = capacidadeInicial[period].input2;

                // Somar capacidade apenas se a quantidade de máquinas for maior que 0
                if (quantidadeJet1 > 0) {
                    novaCapacidade1 += diferencaTurnos * (140/4.5 * quantidadeJet1*480);
                    novaCapacidade2 += diferencaTurnos * (140/4.5 * quantidadeJet1*480);
                }

                if (quantidadeJet2 > 0) {
                    novaCapacidade1 += diferencaTurnos * (140/4.5 * quantidadeJet2*120);
                    novaCapacidade2 += diferencaTurnos * (140/4.5 * quantidadeJet2*120);
                }

                if (quantidadeJet3 > 0) {
                    novaCapacidade1 += diferencaTurnos * (140/4.5 * quantidadeJet3*30);
                    novaCapacidade2 += diferencaTurnos * (140/4.5 * quantidadeJet3*30);
                }

                // Obter o valor inicial de capacidade terceirizada
                let capacidadeTerceirizadaInicialValor = capacidadeTerceirizadaInicial[period];
                // Obter o valor atual de capacidade terceirizada
                let capacidadeTerceirizadaAtual = parseInt(capacidadeTerceirizadaInput.value) || 0;
                // Calcular a diferença de capacidade terceirizada
                let diferencaCapacidadeTerceirizada = capacidadeTerceirizadaAtual - capacidadeTerceirizadaInicialValor;

                // Atualizar os campos de capacidade disponível considerando a capacidade terceirizada
                capacidadeDisponivelInput1.value = novaCapacidade1 + diferencaCapacidadeTerceirizada;
                capacidadeDisponivelInput2.value = novaCapacidade2 + diferencaCapacidadeTerceirizada;
            }
        });
    }

    // Adicionar event listeners para os inputs de número de turnos, quantidade de máquinas e capacidade terceirizada
    periods.forEach(function(period) {
        const turnosInput = document.getElementById(`numero_turnos_${period}`);
        const capacidadeTerceirizadaInput = document.getElementById(`capacidade_terceirizada_${period}`);
        const quantidadeJet1Input = document.getElementById(`quantidade_jet1_${period}`);
        const quantidadeJet2Input = document.getElementById(`quantidade_jet2_${period}`);
        const quantidadeJet3Input = document.getElementById(`quantidade_jet3_${period}`);

        if (turnosInput) {
            turnosInput.addEventListener('input', recalcularCapacidadeDisponivel);
        }

        if (capacidadeTerceirizadaInput) {
            capacidadeTerceirizadaInput.addEventListener('input', recalcularCapacidadeDisponivel);
        }

        if (quantidadeJet1Input) {
            quantidadeJet1Input.addEventListener('input', recalcularCapacidadeDisponivel);
        }

        if (quantidadeJet2Input) {
            quantidadeJet2Input.addEventListener('input', recalcularCapacidadeDisponivel);
        }

        if (quantidadeJet3Input) {
            quantidadeJet3Input.addEventListener('input', recalcularCapacidadeDisponivel);
        }
    });

    // Inicialmente calcular a capacidade disponível ao carregar a página
    recalcularCapacidadeDisponivel();
});

</script>

{% endblock %}
